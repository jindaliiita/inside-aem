<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, viewport-fit=cover"
    />
    <meta name="Description" content="AEM Sidekick Library" />
    <meta name="robots" content="noindex" />
    <base href="/" />
    <style>
        html,
        body {
            margin: 0;
            padding: 0;
            font-family: sans-serif;
            background-color: #ededed;
            height: 100%;
        }

        helix-sidekick { display: none }

        .accordion {
            cursor: pointer;
            padding: 18px;
            width: 100%;
            text-align: left;
            border: none;
            outline: none;
            transition: 0.4s;
        }

        .panel {
            padding: 0 18px;
            display: none;
            overflow: hidden;
            background-color: #f1f1f1;
        }

        .comment-box {
          margin-top: 20px;
        }
        textarea {
          width: 100%;
          height: 80px;
          margin-bottom: 10px;
        }
        .comments {
          margin-top: 20px;
          padding: 10px;
          border: 1px solid #ccc;
          border-radius: 5px;
          background-color: #f9f9f9;
        }
        .comment {
          margin-bottom: 10px;
          padding: 10px;
          border-bottom: 1px solid #ddd;
        }
    </style>
    <title>Sidekick Discussion</title>
</head>

<body>

<script type="module">
    import { fetchDiscussions } from './tools/sidekick/fetch.js';
    import { addCommentById } from './tools/sidekick/addcommentbyid.js';
    import { resolveDiscussion } from './tools/sidekick/close.js';
    import { createDiscussion } from './tools/sidekick/create.js';

    function createNewCommentComponent(discussion_id, element, commentsAll) {
        let commentBox;
        if (!element.querySelector('.comment-box')) {
            commentBox = document.createElement('div');
            commentBox.className = 'comment-box';
            commentBox.style.position = 'absolute';
            commentBox.style.top = '40px';
            commentBox.style.right = '10px';
            commentBox.style.background = '#f9f9f9';
            commentBox.style.border = '1px solid #ccc';
            commentBox.style.padding = '10px';
            commentBox.style.boxShadow = '0 2px 4px rgba(0, 0, 0, 0.2)';
            commentBox.setAttribute('data-discussion-id', discussion_id);

            const textarea = document.createElement('textarea');
            textarea.className = 'comment-textarea';
            textarea.placeholder = 'Add your comment...';
            textarea.style.width = '200px';
            textarea.style.height = '80px';
            textarea.style.marginBottom = '5px';

            const commentsSection = document.createElement('div');
            commentsSection.className = 'comments';
            commentsSection.id = 'comments-section';
            renderFetchedComments(commentsAll, commentsSection);

            const submitButton = createButton('Post Comment', 'submit', '#007bff', '#fff', async () => {
                let commentText = textarea.textContent.trim() || textarea.value.trim();
                if (!commentText) {
                    alert("Comment cannot be empty!");
                    return;
                }
                const email = getSignedInUserEmail();
                if (!email) {
                    alert('Please sign in to post a comment');
                    return;
                }

                let finalComment = `${email}::${commentText}`;
                const obj = {
                    user: email,
                    text: commentText,
                    time: new Date().toLocaleString()
                };
                insertCommentToCommentBox(commentBox, obj);

                addCommentById(discussion_id, finalComment)
                    .then(() => {
                        handlePostDiscussion(discussion_id, element, obj);
                    })
                    .catch(error => console.error('Error adding comment:', error));

                textarea.value = "";
            });

            const resolveButton = createButton('Resolve discussion', 'resolve', '#007bff', '#fff', () => {

                handleResolveDiscussion(
                    discussion_id,
                    commentBox,
                    document.querySelector(`.accordion#${discussion_id}`),
                    document.querySelector(`.panel [data-discussion-id='${discussion_id}']`).parentElement
                );
            });

            const closeButton = document.createElement('button');
            closeButton.textContent = 'X';
            closeButton.style.position = 'absolute';
            closeButton.style.top = '0';
            closeButton.style.right = '0';
            closeButton.addEventListener('click', () => {
                commentBox.style.display = 'none';
                commentBox.remove();
                const accordionTarget = document.querySelector(`.accordion#${discussion_id}`);
                togglePanel(accordionTarget, 'none');
                accordionTarget.classList.remove('active');
            });

            commentBox.appendChild(textarea);
            commentBox.appendChild(commentsSection);
            commentBox.appendChild(submitButton);
            commentBox.appendChild(resolveButton);
            commentBox.appendChild(closeButton);
            element.appendChild(commentBox);
        } else {
            // only add a comment to existing
            commentBox = element.querySelector('.comment-box');

            // add to panel
            const comments_list_ul = document.querySelector(`ul[data-discussion-id="${discussion_id}"]`);
            const numOfComments = comments_list_ul.children.length;
            const commentElement = document.createElement('li');
            commentElement.classList.add(`comment-${numOfComments}`);

            const userEl = document.createElement('span');
            userEl.textContent = commentsAll[0].user;
            userEl.className = 'user';

            const commentEl = document.createElement('p');
            commentEl.textContent = commentsAll[0].text;
            commentEl.className = 'comment-text';

            const timeEl = document.createElement('p');
            timeEl.textContent = commentsAll[0].time;
            timeEl.className = 'time';

            commentElement.appendChild(userEl);
            commentElement.appendChild(commentEl);
            commentElement.appendChild(timeEl);

            comments_list_ul.insertBefore(commentElement, comments_list_ul.firstChild);
        }
        return commentBox;
    }

    document.addEventListener('DOMContentLoaded', async function() {
        let discussions;
        try {
            let data = await fetchDiscussions();
            discussions = data.repository.discussions.nodes;
            console.log('Fetched discussions:', discussions);
        } catch (error) {
            console.error('Error fetching discussions:', error);
        }

        const container = document.createElement('div');
        container.id = "discussion-list";
        document.body.appendChild(container);
        discussions.forEach(discussion => {

            // flatten all comments and rpelies
            let comments = [];
            discussion.comments.nodes.forEach(comment => {
                comments.push({
                    user: comment.body.split('::')[0],
                    text: comment.body.split('::')[1],
                    time: comment.createdAt
                });
                comment.replies.nodes.forEach(reply => {
                    comments.push({
                        user: reply.body.split('::')[0],
                        text: reply.body.split('::')[1],
                        time: reply.createdAt
                    });
                });
            });

            addDiscussionToPanel(discussion.id, discussion.body, comments);
        });
    });

    document.addEventListener('DOMContentLoaded', () => {
        const addCommentIcon = (element) => {
            // Create the + icon if it does not exist
            if (!element.querySelector('.comment-icon')) {
                const icon = document.createElement('div');
                icon.textContent = '+';
                icon.className = 'comment-icon';
                icon.style.position = 'absolute';
                icon.style.top = '10px';
                icon.style.right = '10px';
                icon.style.background = '#007bff';
                icon.style.color = '#fff';
                icon.style.padding = '5px';
                icon.style.borderRadius = '50%';
                icon.style.cursor = 'pointer';
                icon.style.boxShadow = '0 2px 4px rgba(0, 0, 0, 0.2)';

                icon.addEventListener('click', () => {
                    openCommentBox(element);
                });

                element.appendChild(icon);
            }
        };

        // Function to remove the + icon when not hovering
        const removeCommentIcon = (element) => {
            const icon = element.querySelector('.comment-icon');
            if (icon) {
                element.removeChild(icon);
            }
        };

        // Function to open a comment box
        const openCommentBox = async (element) => {
            // Create the comment box if it does not exist
            if (!element.querySelector('.comment-box')) {
                const commentBox = document.createElement('div');
                commentBox.className = 'comment-box';
                commentBox.style.position = 'absolute';
                commentBox.style.top = '40px';
                commentBox.style.right = '10px';
                commentBox.style.background = '#f9f9f9';
                commentBox.style.border = '1px solid #ccc';
                commentBox.style.padding = '10px';
                commentBox.style.boxShadow = '0 2px 4px rgba(0, 0, 0, 0.2)';

                const textarea = document.createElement('textarea');
                textarea.placeholder = 'Add your comment...';
                textarea.style.width = '200px';
                textarea.style.height = '80px';
                textarea.style.marginBottom = '5px';

                const commentsSection = document.createElement('div');
                commentsSection.className = 'comments';
                commentsSection.id = 'comments-section';

                const submitButton = createButton('Post Comment', 'submit', '#007bff', '#fff', async () => {
                    let commentText = textarea.value.trim();
                    if (!commentText) {
                        alert("Comment cannot be empty!");
                        return;
                    }

                    const email = getSignedInUserEmail();
                    if (!email) {
                        alert('Please sign in to post a comment');
                        return;
                    }

                    const finalComment = `${email}::${commentText}`;
                    const obj = {
                        user: email,
                        text: commentText,
                        time: new Date().toLocaleString()
                    }
                    insertCommentToCommentBox(commentBox, obj);

                    let discussion_id = commentBox.getAttribute('data-discussion-id') || null;

                    if(discussion_id == null) {
                        handlePostDiscussion(null, element, obj).then((discussionId) => {
                            if(discussionId) { // case of new discussion
                                commentBox.setAttribute('data-discussion-id', discussionId);
                            }
                        });
                    } else {
                        addCommentById(discussion_id, finalComment)
                            .then(() => {
                                handlePostDiscussion(discussion_id, element, obj);
                            })
                            .catch(error => console.error('Error adding comment:', error));
                    }
                    textarea.value = "";
                    resolveButton.style.display = 'block';
                });

                const resolveButton = createButton('Resolve discussion', 'resolve', '#007bff', '#fff', () => {
                    let discussion_id = commentBox.getAttribute('data-discussion-id');
                    handleResolveDiscussion(
                        discussion_id,
                        commentBox,
                        document.querySelector(`.accordion#${discussion_id}`),
                        document.querySelector(`.panel [data-discussion-id='${discussion_id}']`).parentElement
                    );
                });

                const closeButton = document.createElement('button');
                closeButton.textContent = 'X';
                closeButton.style.position = 'absolute';
                closeButton.style.top = '0';
                closeButton.style.right = '0';
                closeButton.addEventListener('click', () => {
                    commentBox.style.display = 'none';
                    commentBox.remove();
                    if(commentBox.getAttribute('data-discussion-id')) {
                        const discussion_id = commentBox.getAttribute('data-discussion-id');
                        const accordionTarget = document.querySelector(`.accordion#${discussion_id}`);
                        togglePanel(accordionTarget, 'none');
                        accordionTarget.classList.remove('active');
                    }
                });

                commentBox.appendChild(textarea);
                commentBox.appendChild(commentsSection);
                commentBox.appendChild(submitButton);
                commentBox.appendChild(resolveButton);
                commentBox.appendChild(closeButton);
                element.appendChild(commentBox);
            } else {
                //
            }
        };

        // Add event listeners to all blocks and sections
        const elements = parent.document.querySelectorAll('.block, .section');
        elements.forEach(element => {
            element.style.position = 'relative';
            element.style.transition = 'background 0.3s';

            element.addEventListener('mouseenter', () => {
                element.style.background = '#f0f8ff'; // Highlight the element
                // if a discussion exists with text in accordion as this buildSelector
                const selector = buildSelector(element);
                const accordionBtns = document.querySelectorAll('.accordion');
                const exists = Array.from(accordionBtns).some(btn => btn.textContent === selector);
                if (!exists) {
                    addCommentIcon(element);
                }
            });

            element.addEventListener('mouseleave', () => {
                element.style.background = ''; // Remove highlight
                removeCommentIcon(element);
            });
        });
    });

    function createButton(text, className, bgColor, color, onClick) {
        const button = document.createElement('button');
        button.className = className;
        button.textContent = text;
        button.style.background = bgColor;
        button.style.color = color;
        button.style.border = 'none';
        button.style.padding = '5px 10px';
        button.style.cursor = 'pointer';
        button.style.borderRadius = '3px';
        button.addEventListener('click', onClick);
        return button;
    }

    function togglePanel(elem, state) {
        var panel = elem.nextElementSibling;
        if(state) {
            panel.style.display = state;
            return;
        }
        if (panel.style.display === 'block') {
            panel.style.display = 'none';
        } else {
            panel.style.display = 'block';
            panel.scrollIntoView({ behavior: 'smooth' });
        }
    }

    function renderFetchedComments(comments, commentsSectionElem) {
        comments.forEach(comment => {
            const newComment = document.createElement('div');
            newComment.className = 'comment';
            commentsSectionElem.appendChild(newComment);

            const userEl = document.createElement('span');
            userEl.textContent = comment.querySelector('.user').textContent.trim();
            userEl.className = 'user-box';

            const commentEl = document.createElement('p');
            commentEl.textContent = comment.querySelector('.comment-text').textContent.trim();
            commentEl.className = 'comment-text-box';

            const timeEl = document.createElement('p');
            timeEl.textContent = comment.querySelector('.time').textContent.trim();
            timeEl.className = 'time-box';

            newComment.appendChild(userEl);
            newComment.appendChild(commentEl);
            newComment.appendChild(timeEl);

        });
    }

    function getSignedInUserEmail() {
        const emailElement = parent.document.querySelector('helix-sidekick').shadowRoot.querySelector('.profile-email');
        return emailElement ? emailElement.textContent : null;
    }

    function buildSelector(element) {
        if (!element) return '';
        const parts = [];
        while (element.parentElement) {
            const tag = element.tagName.toLowerCase();
            let selector = tag;
            if (element.id) {
                selector += `#${element.id}`;
            } else if (element.classList.length > 0) {
                selector += `.${Array.from(element.classList).join('.')}`;
            }
            parts.unshift(selector);
            element = element.parentElement;
        }
        return parts.join(' > ');
    }

    function createDiscussionInPanel(discussionId, selector, commentText) {

        const button = document.createElement('button');
        button.className = 'accordion';
        button.textContent = selector;
        button.id = discussionId;

        const panel = document.createElement('div');
        panel.className = 'panel';
        const commentList = document.createElement('ul');
        commentList.className = 'comment-list';
        commentList.setAttribute('data-discussion-id', discussionId);
        panel.appendChild(commentList);

        const commentElement = document.createElement('li');
        commentElement.classList.add(`comment-0`);
        commentElement.textContent = commentText;
        commentList.appendChild(commentElement);

        const container = document.getElementById('discussion-list');
        container.appendChild(button);
        container.appendChild(panel);

        button.addEventListener('click', function() {
            var buttonValue = this.textContent;

            var targetElement = parent.document.querySelector(buttonValue);
            if (targetElement) {
                console.log('found target element' + targetElement);
                targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

            if (this.classList.contains('active')) {
                togglePanel(this);
                return;
            }
            this.classList.toggle('active');
            const discussion_id = this.id;
            const comments_list = document.querySelectorAll(`ul[data-discussion-id="${discussion_id}"] li`);

            if (!targetElement.querySelector('.comment-box')) {
                const comment_component = createNewCommentComponent(discussion_id, targetElement, comments_list);
                comment_component.style.display = 'block';
                targetElement.appendChild(comment_component);
                togglePanel(this);
            }
        });
    }

    function addDiscussionToPanel(discussionId, selector, comments) {

        const button = document.createElement('button');
        button.className = 'accordion';
        button.textContent = selector;
        button.id = discussionId;

        const panel = document.createElement('div');
        panel.className = 'panel';
        const commentList = document.createElement('ul');
        commentList.className = 'comment-list';
        commentList.setAttribute('data-discussion-id', discussionId);
        panel.appendChild(commentList);


            comments.forEach((comment, index) => {
                const commentElement = document.createElement('li');
                commentElement.classList.add(`comment-${index}`);

                const userEl = document.createElement('span');
                userEl.textContent = comment.user;
                userEl.className = 'user';

                const commentEl = document.createElement('p');
                commentEl.textContent = comment.text;
                commentEl.className = 'comment-text';

                const timeEl = document.createElement('p');
                timeEl.textContent = comment.time;
                timeEl.className = 'time';

                commentElement.appendChild(userEl);
                commentElement.appendChild(commentEl);
                commentElement.appendChild(timeEl);

                commentList.appendChild(commentElement);
            });


        const container = document.getElementById('discussion-list');
        container.appendChild(button);
        container.appendChild(panel);

        button.addEventListener('click', function() {
            var buttonValue = this.textContent;

            var targetElement = parent.document.querySelector(buttonValue);
            if (targetElement) {
                console.log('found target element' + targetElement);
                targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

            if (this.classList.contains('active')) {
                togglePanel(this);
                return;
            }
            this.classList.toggle('active');
            const discussion_id = this.id;
            const comments_list = document.querySelectorAll(`ul[data-discussion-id="${discussion_id}"] li`);

            if (!targetElement.querySelector('.comment-box')) {
                const comment_component = createNewCommentComponent(discussion_id, targetElement, comments_list);
                comment_component.style.display = 'block';
                targetElement.appendChild(comment_component);
                togglePanel(this);
            }
        });
    }

    function handlePostDiscussion(discussion_id, element, comment) {

        if(discussion_id === null) { // new discussion
            const elSelector = buildSelector(element);
            return createDiscussion(window.top.location.pathname, elSelector, `${comment.user}::${comment.text}`)
                .then(discussionId => {
                    addDiscussionToPanel(discussionId, elSelector, [comment]);
                    return discussionId;
                });
        } else {
            createNewCommentComponent(discussion_id, element, [comment]);
        }
    }

    function handleResolveDiscussion(discussionId, commentBox, button, panel) {

        commentBox.style.display = 'none';
        commentBox.remove();

        const email = getSignedInUserEmail();
        if (!email) {
            alert('Please sign in to resolve the discussion');
            return;
        }

        const closingText = `${email} - closed this discussion`;
        addCommentById(discussionId, closingText)
            .then(() => {
                resolveDiscussion(discussionId);
                button.remove();
                panel.remove();
            })
            .catch(error => console.error('Error resolving discussion:', error));
    }

    function insertCommentToCommentBox(commentBox, commentText) {
        const commentsSection = commentBox.querySelector('.comments');
        const newComment = document.createElement('div');
        newComment.className = 'comment';

        const userEl = document.createElement('span');
        userEl.textContent = commentText.user;
        userEl.className = 'user';

        const commentEl = document.createElement('p');
        commentEl.textContent = commentText.text;
        commentEl.className = 'comment-text';

        const timeEl = document.createElement('p');
        timeEl.textContent = commentText.time;
        timeEl.className = 'time';

        newComment.appendChild(userEl);
        newComment.appendChild(commentEl);
        newComment.appendChild(timeEl);

        commentsSection.insertBefore(newComment, commentsSection.firstChild);
    }
</script>

</body>
</html>
